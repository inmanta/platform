#!/bin/bash

hostname {{ vm.name }}
setenforce 0

{% if branch == "dev" %}
cat > /etc/yum.repos.d/inmanta_oss_dev.repo <<EOF
[inmanta-oss-dev]
name=Inmanta OSS Dev snapshots
baseurl=https://pkg.inmanta.com/inmanta-oss-dev/el7/
gpgcheck=1
gpgkey=https://pkg.inmanta.com/inmanta-oss-dev/inmanta-oss-dev-public-key
repo_gpgcheck=1
enabled=1
enabled_metadata=1
EOF
{% else %}
cat > /etc/yum.repos.d/inmanta_oss_stable.repo <<EOF
[inmanta-oss-stable]
name=Inmanta OSS stable
baseurl=https://pkg.inmanta.com/inmanta-oss-stable/el7/
gpgcheck=1
gpgkey=https://pkg.inmanta.com/inmanta-oss-stable/inmanta-oss-stable-public-key
repo_gpgcheck=1
enabled=1
enabled_metadata=1
EOF
{% endif %}

yum install -y epel-release
yum install -y python34-devel gcc git python3-inmanta-agent

cat > /etc/inmanta/agent.cfg <<EOF
[config]
agent_splay=10
heartbeat-interval = 60
fact-expire = 60
state-dir=/var/lib/inmanta

environment={{ env_id }}
agent-names=\$node-name

[agent_rest_transport]
port={{port}}
host={{env_server}}
EOF

systemctl start inmanta-agent
systemctl enable inmanta-agent
